var express=require("express");const session=require("express-session");var app=express();app.use(session({resave:!0,saveUninitialized:!0,secret:"somesecret",cookie:{maxAge:6e4}})),app.use(express.static("public")),app.set("view engine","ejs"),app.set("views","./views"),app.listen(3e3);var bodyParser=require("body-parser"),urlencodedParser=bodyParser.urlencoded({extended:!1}),http=require("http").createServer(app),pg=require("pg"),config={user:"postgres",database:"DOAN",password:"123123as",host:"localhost",port:5432,max:10,idleTimeoutMillis:3e4},pool=new pg.Pool(config);app.use("/public",express.static("public")),app.get("/hodan/list",(function(req,res){pool.connect((err,client,release)=>{if(req.session.username){if(err)return console.error("Error acquiring client",err.stack);client.query("SELECT * FROM ho_dan_point ORDER BY id_hodan ASC",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.render("hodan_list.ejs",{danhsach:result})})}else res.redirect("/login")})})),app.get("/hodan/them",(function(req,res){res.render("hodan_insert.ejs")})),app.post("/hodan/them",urlencodedParser,(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);var hoten=req.body.txtHoten,diachi=req.body.txtDiachi,tinhtrang=req.body.txtTinhtrang,ngaydk=req.body.txtNgaydk,tdx=req.body.txtX,tdy=req.body.txtY,idkhupho=req.body.txtKhupho;client.query("insert into ho_dan_point (chuho,diachi,tinhtrang,ngaydangky,geom,id_khupho) values ('"+hoten+"','"+diachi+"','"+tinhtrang+"','"+ngaydk+"','SRID=4326;POINT("+tdx+" "+tdy+")','"+idkhupho+"')",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.redirect("../hodan/list")})})})),app.get("/hodan/sua/:id_hodan",(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);var id_hodan=req.params.id_hodan;client.query("SELECT * FROM ho_dan_point WHERE id_hodan='"+id_hodan+"'",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.render("hodan_edit.ejs",{hd:result.rows[0]})})})})),app.post("/hodan/sua",urlencodedParser,(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);var id=req.body.txtID,hoten=req.body.txtHoten,diachi=req.body.txtDiachi,tinhtrang=req.body.txtTinhtrang,ngaydk=req.body.txtNgaydk,geom=req.body.txtGeom,khu=req.body.txtKhu,tdx=req.body.txtX,tdy=req.body.txtY;client.query("UPDATE ho_dan_point SET chuho='"+hoten+"', diachi='"+diachi+"', tinhtrang='"+tinhtrang+"',ngaydangky='"+ngaydk+"',geom='"+geom+"',id_khupho='"+khu+"' WHERE id_hodan='"+id+"'  ",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.redirect("../hodan/list")})})})),app.get("/hodan/xoa/:id_hodan",(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);var id_hodan=req.params.id_hodan;client.query("DELETE FROM ho_dan_point WHERE id_hodan='"+id_hodan+"' ",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.redirect("../../hodan/list")})})})),app.get("/nhankhau",(function(req,res){pool.connect((err,client,release)=>{if(req.session.username){if(err)return console.error("Error acquiring client",err.stack);client.query("SELECT * FROM nhan_khau ORDER BY id_nhankhau ASC",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.render("nhankhau_list.ejs",{danhsach:result})})}else res.redirect("/login")})})),app.get("/nhankhau/them",(function(req,res){res.render("nhankhau_insert.ejs")})),app.post("/nhankhau/them",urlencodedParser,(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);var hoten=req.body.txtHoten,gioitinh=req.body.txtGioitinh,ngaysinh=req.body.txtNgaysinh,nghenghiep=req.body.txtNghenghiep,qhch=req.body.txtQuanhech,idhodan=req.body.txtIdhodan,tinhtrang=req.body.txtTinhtrang;client.query("insert into nhan_khau (ten,gioitinh,ngaysinh,nghenghiep,quanhe_ch,id_hodan,tinhtrang) values ('"+hoten+"','"+gioitinh+"','"+ngaysinh+"','"+nghenghiep+"','"+qhch+"','"+idhodan+"','"+tinhtrang+"')",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.redirect("../nhankhau")})})})),app.get("/hodan/thongke",(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);client.query("select vk.ten_khu,sum(case when nk.tinhtrang=N'Da di' then 1 else 0 end) as nvqs_dadi,sum(case when nk.tinhtrang=N'Chua di' then 1 else 0 end) as nvqs_chuadi,sum(case when nk.tinhtrang=N'Da tiem' then 1 else 0 end) as tiemchung_datiem,sum(case when nk.tinhtrang=N'Chua tiem' then 1 else 0 end) as tiemchung_chuatiem from ho_dan_point hd join nhan_khau nk on  nk.id_hodan = hd.id_hodan join vung_khu_region vk on vk.id_khupho = hd.id_khupho group by vk.ten_khu ORDER BY vk.ten_khu ASC",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.render("thongke.ejs",{danhsach:result})})})})),app.get("/hodan/thongketuoi",(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);client.query("select *,extract(year from age(current_date,ngaysinh))::int as age from nhan_khau where extract(year from age(current_date,ngaysinh))::int >18 and extract(year from age(current_date,ngaysinh))::int <27 and gioitinh=N'Nam'",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.render("thongketuoi.ejs",{danhsach:result})})})})),app.get("/hodan/thongketiemchung",(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);client.query("select *,age(now(),ngaysinh) as age from nhan_khau where extract(year from age(current_date,ngaysinh))::int >=0 and extract(year from age(current_date,ngaysinh))::int <=1",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.render("thongketuoi.ejs",{danhsach:result})})})})),app.get("/login",(function(req,res){res.sendFile("login.html",{root:__dirname})})),app.post("/login",urlencodedParser,(function(req,res){var username=req.body.username,password=req.body.password;pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);"admin"==username?client.query("SELECT * FROM taikhoan WHERE  username='"+username+"' AND password='"+password+"' LIMIT 1",(function(err,result){if(release(),err)return res.end(),console.error("Error executing query",err.stack);var sessData;result.rows.length>=0?(req.session.username=username,console.log(username+password),res.redirect("/hodan/list")):res.redirect("/login")})):client.query("SELECT * FROM ho_dan_point WHERE tendangnhap=$1 AND matkhau=$2  LIMIT 1",[username,password],(function(err,result){if(release(),err)return res.end(),console.error("Error executing query",err.stack);var sessData;"Đã duyệt"===result.rows[0].duyet?(req.session.username=username,res.redirect("/")):res.redirect("/login")}))})})),app.get("/dangky",(function(req,res){res.render("dangkyhd.ejs")})),app.post("/dangky",urlencodedParser,(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);var hoten=req.body.txtHoten,diachi=req.body.txtDiachi,tinhtrang=req.body.txtTinhtrang,ngaydk=req.body.txtNgaydk,tdx=req.body.txtX,tdy=req.body.txtY,idkhupho=req.body.txtKhupho,tendangnhap=req.body.txtUser,password=req.body.txtPass;client.query("insert into ho_dan_point (chuho,diachi,tinhtrang,ngaydangky,geom,id_khupho,tendangnhap,matkhau,duyet) values ('"+hoten+"','"+diachi+"','"+tinhtrang+"','"+ngaydk+"','SRID=4326;POINT("+tdx+" "+tdy+")','"+idkhupho+"','"+tendangnhap+"','"+password+"',N'Chưa duyệt')",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.redirect("../hodan/list")})})})),app.get("/hodan/duyet/:id_hodan",(function(req,res){pool.connect((err,client,release)=>{if(err)return console.error("Error acquiring client",err.stack);var id_hodan=req.params.id_hodan;client.query("UPDATE ho_dan_point set duyet=N'Đã duyệt' WHERE id_hodan='"+id_hodan+"'",(err,result)=>{if(release(),err)return res.end(),console.error("Error executing query",err.stack);res.redirect("../../hodan/list")})})})),app.get("/logout",(function(req,res){req.session.destroy(),res.redirect("/")})),app.get("/",(function(req,res){res.render("main")}));